DECLARE @idCliente AS INT
DECLARE @idDomicilioReceptor AS INT
DECLARE @idDetalleFactura AS INT
DECLARE @claveProducto AS VARCHAR
DECLARE @idCatProducto AS INT
DECLARE @idFactura AS INT

SELECT 
  @idCliente=c.idcliente, 
  @idDomicilioReceptor=cd.idDomicilio
FROM OptimusDB.dbo.Cliente c with(nolock) 
INNER JOIN OptimusDB.dbo.ClienteDomicilio cd with(nolock) on cd.idcliente = c.idCliente
WHERE c.rfc in ('{{RFC}}');

INSERT INTO OptimusDB.dbo.Factura
(
  idCliente, idEmpresa, idCatTipoMoneda,
  idCatTipoComprobante, idCatMotivoDescuento, idDomicilioReceptor,
  idDomicilioEmisor, idCatFormaPago, idPedido,
  idFacturaRelacionada, serie, folio,
  rfc, razonSocial, descuento,
  vigente, conciliada, total,
  iva, subTotal, uuid,
  cambio, parcialidades, parcialidad,
  generaCorte, fechaMaximaPago, fechaFacturacion,
  fechaCancelacion, fechaCreacion, fechaModificacion,
  idUsuarioModifico, idCatEstatusFactura, observaciones,
  condicionesPago, cSatTipoDeComprobante, cSatPais,
  cSatUsoCFDI, cSatMetodoPago, cSatMoneda,
  version{{columnasUuidRelacionado}}
) VALUES (
  @idCliente,1,1,
  1,5,@idDomicilioReceptor,
  265542,{{idCatFormaPago}}, null,
  null,'{{serie}}',{{folio}},
  '{{RFC}}','{{nombre}}',0,
  1,0,{{total}},
  {{iva}},{{subTotal}},'{{uuid}}',
  1,null,1,
  1,null,'{{fecha}}',
  null,'{{fecha}}',null,
  116497,1,'',
  '','I','MEX',
  'G03','{{metodoPago}}','MXN',
  '{{version}}'{{uuidRelacionado}}
)
{{#conceptos}}

SELECT 
  @claveProducto=claveproducto, 
  @idCatProducto=idcatproducto
FROM OptimusDB.dbo.CatProducto
WHERE claveProducto in ('{{noIdentificacion}}')
AND fechaCreacion >= '2024-01-01 00:00:00';

SELECT
  @idFactura=f.idFactura
FROM OptimusDB.dbo.factura f with(nolock)
INNER JOIN OptimusDB.dbo.cliente c with(nolock) on f.idcliente = c.idcliente 
WHERE f.uuid IN ('{{uuid}}') 
AND f.idcliente IN (@idCliente)
ORDER BY f.idfactura;

INSERT INTO OptimusDB.dbo.DetalleFactura (
  idFactura, idCatProducto, serie,
  folio, rfc, uuid,
  claveProducto, unidad, descripcion,
  valorUnitario, importe, descuento,
  descuentoPorcentaje, fechaCreacion, idUsuarioModifico,
  claveProdServ, c_ClaveUnidad, cantidad
) VALUES (
  @idFactura,@idCatProducto,'{{serie}}',
  '{{folio}}','{{RFC}}','{{uuid}}',
  '{{noIdentificacion}}','{{unidad}}','{{descripcion}}',
  {{valorUnitario}},{{importe}},0,
  0,'{{fecha}}',116497,
  {{claveProdServ}},'{{claveUnidad}}',{{cantidad}}
)

SELECT @idDetalleFactura=idDetalleFactura
FROM OptimusDB.dbo.DetalleFactura 
WHERE idfactura in (@idFactura)
ORDER BY idFactura;

INSERT INTO OptimusDB.dbo.DetalleFacturaImpuesto(
  idDetalleFactura, idCatImpuesto, tasa,
  valor, fechaCreacion, idUsuarioModifico,
  c_impuesto, valorMaximo
) VALUES (
  @idDetalleFactura,1,16,
  {{impuestoConcepto}},'{{fecha}}',116497,
  2,0.16
)

INSERT INTO OptimusDB.dbo.Cargo(
  idCliente, idFactura, valor,
  valorPagado, valorSaldo, nombre,
  descripcion, liquidado, fechaCreacion,
  fechaModificacion, idUsuarioModifico
) VALUES (
  @idCliente,@idFactura,-{{totalConcepto}},
  0,'-{{totalConcepto}}','{{noIdentificacion}}',
  '{{descripcion}}',0,'{{fecha}}',
  NULL,116497
)
{{/conceptos}}

GO